import{bp as ge,bq as he,br as we,bs as ke,d as y,b as g,bt as le,a3 as B,aF as Ce,u as P,bu as I,r as F,w as S,e,bv as ue,bw as A,n as C,h as N,a2 as E,F as x,aJ as xe,bx as V,V as f,by as Ne,v as ne,aa as Be,bz as $,b1 as Se,bA as Fe,q as w,Q as Ee,bd as Pe,o as R,H as _,$ as Ie,as as se,R as m,bB as re,ai as Ae,bC as Te,bD as De,bE as je,bF as z,bG as Oe,B as b,bH as Ve,f as d,N as Ue,i as D,M as oe,bo as U,bj as ie,a1 as j,s as qe,m as Ke,bn as Me,I as M,A as ce,g as de,aY as Le,bI as pe,y as fe,aW as H,bc as W,bJ as G,b5 as $e,bK as me,ah as Re,c as _e,bL as ze,bM as J,bN as He,U as We,Y as Ge,aj as Je,ak as q,C as Xe}from"./index-CbB7mK5o.js";import{_ as X}from"./CheckCircleOutlined-BhwiGGQZ.js";import{i as L}from"./isEmpty-D6DEV_eg.js";import{c as ve}from"./cloneDeep-CxLF8f8t.js";import{N as Ye,a as Qe}from"./ListItem-DrLEuo7D.js";import{K as Ze}from"./index-DJIL3jOI.js";import{U as et}from"./index-kEG0j_JJ.js";import{N as tt}from"./Upload-BmSKZ3tn.js";import"./_baseClone-D1KVKLvw.js";function at(t){return ge(he(t).toLowerCase())}var lt=we(function(t,u,s){return u=u.toLowerCase(),t+(s?at(u):u)});function Y(t,u,s){return t==null?t:ke(t,u,s)}const Q=y({props:{condition:{type:[Boolean,Function],required:!0}},setup(t,{slots:u}){const s=()=>{if(typeof t.condition=="function"?t.condition():t.condition)return u.default?.()};return()=>s()}});function K(t){return typeof t=="function"||Object.prototype.toString.call(t)==="[object Object]"&&!ne(t)}const ut="mt-6",nt={class:ut,labelPlacement:"left",labelAlign:"right",labelWidth:150,autocomplete:"do-not-autofill"},be=Symbol("JSONSchemaFormInject"),st=y({props:{schema:{type:Object,required:!0},onValueChange:{type:Function,required:!1},initialValue:{type:Object,required:!0},getKey:{type:Function,required:!1,default:t=>t},extendConfigView:{type:Object}},setup(t,{slots:u}){const s=g(t.initialValue);le(()=>{t.onValueChange?.(s.value)},{flush:"post"});const c=B(()=>t.schema.definitions),r=B(()=>new Map(Object.entries(t.schema.definitions)));Ce(be,{schema:t.schema,definitions:r,getKey:t.getKey});const o=B(()=>Object.keys(c.value)),l=g([o.value[0]]),i=P(I),a=F(nt);return S(()=>i.viewport.value.mobile,n=>{n?(a.labelPlacement="top",a.labelAlign="left"):(a.labelPlacement="left",a.labelAlign="right")},{immediate:!0}),()=>{let n,p;const{schema:h}=t;return e(x,null,[e(ue,{accordion:!0,defaultExpandedNames:l.value,displayDirective:"if"},K(n=o.value.map(v=>{const k=c.value[v];if(!k.title)return null;switch((k?.["ui:options"]||{})?.type){case"hidden":return null}return e(A,{title:k.title,"data-schema":JSON.stringify(k)},{default:()=>[e(C,a,{default:()=>[e(ye,{dataKey:t.getKey(v),formData:s,schema:k,property:v},null),t.extendConfigView?.[v],u[v]?.()]})]})}))?n:{default:()=>[n]}),h.ps.length?e(N,{vertical:!0},K(p=h.ps.map(v=>e(E,{class:"ml-4 mt-8 inline-block text-xs",depth:3},K(v)?v:{default:()=>[v]})))?p:{default:()=>[p]}):null])}}}),ye=y({props:{schema:{type:Object,required:!0},formData:{type:Object,required:!0},dataKey:{type:String,required:!0},property:{type:String}},setup(t){const{definitions:u,getKey:s}=xe(be,{});return()=>{const{schema:c,formData:r,dataKey:o,property:l}=t;return c?e(x,null,[Object.keys(c.properties).map(i=>{const a=c.properties[i];if(a.$ref){const n=u.value.get(a.$ref.split("/").at(-1));return e(ye,{dataKey:`${s(o)}.${i}`,formData:r,schema:n,property:i},null)}return e(rt,{value:V(r.value,`${s(o)}.${i}`,void 0),onUpdateValue:n=>{V(r.value,s(o))?Y(r.value,`${s(o)}.${i}`,n):Y(r.value,s(o),{...V(r.value,s(o),{}),[i]:n})},title:a.title,type:a.type,options:a?.["ui:options"],description:a.description},null)})]):null}}}),rt=y({props:{type:{type:String,required:!0},title:{type:String,required:!0},description:{type:String},options:{type:Object,default:()=>({})},value:{type:Object,required:!0},onUpdateValue:{type:Function,required:!0}},setup(t){const u=g(t.value);le(()=>{t.onUpdateValue(u.value)});const s=()=>{const{options:o}=t;switch(t.type){case"url":case"string":{const{type:l}=o;switch(l){case"select":const{values:i}=o;return e(Ee,{value:u.value,onUpdateValue:a=>{u.value=a},options:i,filterable:!0},null);default:return e(w,{inputProps:{id:Fe()},value:u.value,onUpdateValue:a=>{u.value=a},type:l||"text",showPasswordOn:"click",autosize:l=="textarea"?{maxRows:5,minRows:3}:void 0,clearable:!0},null)}}case"array":return e(Se,{value:u.value,onUpdateValue:l=>{u.value=l}},null);case"boolean":return e($,{value:u.value,onUpdateValue:l=>{u.value=l}},null);case"integer":return e(Be,{value:u.value,onUpdateValue:l=>{u.value=l}},null);default:return null}},c=P(I),r=B(()=>c.viewport.value.mobile?1:2);return()=>{const{title:o,options:l,description:i}=t,a=e(x,null,[e(f,{label:o},{default:()=>[i?e(N,{class:"w-full",vertical:!0},{default:()=>[s(),e(E,{class:"text-xs",depth:3},{default:()=>[e("span",{innerHTML:Ne.parse(i)},null)]})]}):s()]})]);return l.halfGrid&&r.value===2?e("div",{class:"inline-block w-1/2"},[a]):a}}}),ot="mt-6",it={class:ot,labelPlacement:"left",labelAlign:"right",labelWidth:150,autocomplete:"chrome-off"},Z={autosize:!0,clearable:!0,style:"min-width: 300px; max-width: 100%"},ct=y(()=>{const{setHeaderButtons:t}=Pe();R(()=>{t(e(_,{disabled:!0,onClick:o,icon:e(X,null,null)},null))}),Ie(()=>{t(null)});const u=g();se(async()=>{u.value=await m.api.config.jsonschema.get({transform:!1}),await l()});let s={};const c=F({}),r=g({});S(()=>c,n=>{r.value=re(s,Ae(n))},{deep:!0}),S(()=>r.value,n=>{let p=!1;L(n)?p=!1:p=!0,t(e(_,{disabled:!p,icon:e(X,null,null),onClick:o},null))});async function o(){if(L(r.value))return;const n=Object.entries(r.value);for await(const[p,h]of n){const v=Object.fromEntries(Object.entries(h).map(([k,O])=>Array.isArray(O)?[k,c[p][k]]:[k,O]));await m.api.options(p).patch({data:v})}await l(),message.success("修改成功")}const l=async()=>{let n=await m.api.options.get();n=Te(u.value.default,n),s=ve(n),Object.assign(c,n)},i=P(I),a=F(it);return S(()=>i.viewport.value.mobile,n=>{n?(a.labelPlacement="top",a.labelAlign="left"):(a.labelPlacement="left",a.labelAlign="right")},{immediate:!0}),()=>e(x,null,[e("div",{class:"pt-4"},null),u.value&&e(st,{initialValue:c,getKey:n=>n.split(".").map(p=>lt(p)).join(".").replace("Dto",""),schema:u.value},{AdminExtraDto(){return e(x,null,[e(f,{label:"主题色"},{default:()=>[e(dt,null,null)]})])}})])}),dt=y({setup(){const t=De(),u=document.createElement("style");return u.innerHTML="* { transition: none !important; }",()=>e("div",{class:"flex items-center gap-2"},[e(je,{class:"w-36",value:t.value.primaryColor,onUpdateValue:s=>{document.head.appendChild(u),Object.assign(z.value,Oe(s)),setTimeout(()=>{document.head.removeChild(u)})}},null),e(b,{size:"small",ghost:!0,onClick:()=>{Object.assign(z.value,Ve)}},{default:()=>[e("span",null,[d("重置")])]})])}});function ee(t){return typeof t=="function"||Object.prototype.toString.call(t)==="[object Object]"&&!ne(t)}const pt=y(()=>{const t=g([]),u=async()=>{const r=await m.api.user.session.get({});t.value=[...r.data]};R(()=>{u()});const s=async(r,o)=>{r?(await m.api.user.logout.post({}),me(),window.location.reload()):(await m.api.user.session(o).delete({}),t.value=t.value.filter(l=>l.id!==o))},c=async()=>{await m.api.user.session.all.delete({}),await u()};return()=>{let r;return e(x,null,[e(Ue,{class:"flex items-center justify-between"},{default:()=>[e("span",{class:"ml-4"},[d("登录设备")]),e(D,{onPositiveClick:c},{trigger(){return e(b,{size:"small",quaternary:!0,type:"error",disabled:t.value.length==1&&t.value[0].current},{default:()=>[d("踢掉全部")]})},default(){return"确定踢掉全部登录设备（除当前会话）？"}})]}),e(Ye,{bordered:!0},ee(r=t.value.map(({id:o,ua:l,ip:i,date:a,current:n})=>e(Qe,{key:o},{prefix(){return e("div",{class:"w-20 text-center"},[n?"当前":null])},suffix(){return e(oe,null,{default:()=>[e(D,{onPositiveClick:()=>s(!!n,o)},{trigger(){return e(b,{tertiary:!0,type:"error"},{default:()=>[n?"注销":"踢"]})},default(){return n?"登出？":"确定要踢出吗？"}})]})},default(){return e(N,{vertical:!0},{default:()=>[e(Q,{condition:!!l},{default:()=>[e(U,null,{default:()=>[d("User Agent: "),l]})]}),e(Q,{condition:!!i},{default:()=>[e(U,null,{default:()=>[d("IP:")," ",e(ie,{ip:i,triggerEl:e(b,{quaternary:!0,size:"tiny",type:"primary"},ee(i)?i:{default:()=>[i]})},null)]})]}),e(U,null,{default:()=>[n?"活跃时间":"登录时间",d(":")," ",e(j,{time:a},null)]})]})}})))?r:{default:()=>[r]}),e("div",{class:"pt-4"},null),e(ue,{defaultExpandedNames:[""],displayDirective:"show"},{default:()=>[e(A,{name:"reset",title:"修改密码"},{default:()=>[e(mt,null,null)]}),e(A,{name:"token",title:"API Token"},{default:()=>[e(ft,null,null)]}),e(A,{name:"passkey",title:"Passkey"},{default:()=>[e(vt,null,null)]})]})])}}),ft=y(()=>{const t=g([]),u=()=>({name:"",expired:!1,expiredTime:new Date}),s=F(u()),c=async()=>{const{data:a}=await m.api.auth.token.get();t.value=a};se(()=>{c()});const r=g(!1),o=async()=>{const a={name:s.name,expired:s.expired?s.expiredTime.toISOString():void 0},n=await m.api.auth.token.post({data:a});await navigator.clipboard.writeText(n.token),r.value=!1;const p=u();for(const v in p)s[v]=p[v];message.success(`生成成功，Token 已复制，${n.token}`),await c();const h=t.value.findIndex(v=>v.name===a.name);h!==-1&&(t.value[h].token=n.token)},l=async a=>{await m.api.auth.token.delete({params:{id:a}}),message.success("删除成功");const n=t.value.findIndex(p=>p.id===a);n!=-1&&t.value.splice(n,1)},i=P(I);return()=>e(pe,{class:"!overflow-visible"},{default:()=>[e(qe,{transformOrigin:"center",show:r.value,onUpdateShow:a=>void(r.value=a)},{default:()=>[e(Ke,{bordered:!1,title:"创建 Token",class:"w-[500px] max-w-full"},{default:()=>[e(C,null,{default:()=>[e(f,{label:"名称",required:!0},{default:()=>[e(w,{value:s.name,onInput:a=>void(s.name=a)},null)]}),e(f,{label:"是否过期"},{default:()=>[e($,{value:s.expired,onUpdateValue:a=>void(s.expired=a)},null)]}),e(f,{label:"过期时间"},{default:()=>[e(Me,{disabled:!s.expired,value:s.expiredTime,type:"datetime",onUpdateValue:a=>void(s.expiredTime=new Date(a))},null)]})]}),e(N,null,{default:()=>[e(b,{round:!0,onClick:()=>void(r.value=!1)},{default:()=>[d("取消")]}),e(b,{round:!0,type:"primary",onClick:o},{default:()=>[d("确定")]})]})]})]}),e(b,{class:"absolute right-0 top-[-3rem]",round:!0,type:"primary",onClick:()=>{r.value=!0}},{default:()=>[e(M,null,{default:()=>[e(ce,null,null)]}),e("span",{class:"ml-2"},[d("新增")])]}),e(de,{scrollX:Math.max(800,i.contentWidth.value-i.contentInsetWidth.value),remote:!0,bordered:!1,data:t.value,columns:[{key:"name",title:"名称"},{key:"token",title:"Token",render({token:a}){return"*".repeat(40)}},{title:"创建时间",key:"created",render({created:a}){return e(j,{time:a},null)}},{title:"过期时间",key:"expired",render({expired:a}){return Le(a,"yyyy 年 M 月 d 日 HH:mm:ss")}},{title:"操作",key:"id",render({id:a,name:n}){return e(N,null,{default:()=>[e(D,{positiveText:"取消",negativeText:"删除",onNegativeClick:()=>{l(a)}},{trigger:()=>e(b,{text:!0,type:"error"},{default:()=>[d("删除")]}),default:()=>e("span",{class:"max-w-48"},[d('确定要删除 Token "'),n,d('"?')])})]})}}]},null)]})}),mt=y(()=>{const t=F({password:"",reenteredPassword:""}),u=g(),s=fe(),c=async()=>{u.value&&u.value.validate(async o=>{o?console.log(o):(await m.api.master.patch({data:{password:t.password}}),message.success("更改成功"),me(),s.push({name:Re.Login}))})};function r(o,l){return console.log(o),l===t.password}return()=>e(C,{class:"max-w-[300px]",ref:u,model:t,rules:{password:[{required:!0,message:"请输入密码"}],reenteredPassword:[{required:!0,message:"请再次输入密码",trigger:["input","blur"]},{validator:r,message:"两次密码输入不一致",trigger:["blur","password-input"]}]}},{default:()=>[e(f,{label:"新密码",required:!0,path:"password"},{default:()=>[e(w,H(Z,{value:t.password,onInput:o=>void(t.password=o),type:"password"}),null)]}),e(f,{label:"重复密码",required:!0,path:"reenteredPassword"},{default:()=>[e(w,H(Z,{value:t.reenteredPassword,onInput:o=>void(t.reenteredPassword=o),type:"password"}),null)]}),e("div",{class:"quaternary-right w-full"},[e(b,{onClick:c,type:"primary",round:!0},{default:()=>[d("保存")]})])]})}),vt=y(()=>{const t=P(I),{data:u,mutate:s}=W("passkey-table",()=>m.api.passkey.items.get()),c=a=>{m.api.passkey.items(a).delete().then(()=>{s()})},r=y(a=>{const n=g(""),p=h=>{h.preventDefault(),h.stopPropagation(),G.createPassKey(n.value).then(()=>{s(),a.dialog.destroy()})};return()=>e(C,{onSubmit:p},{default:()=>[e(f,{label:"名称",required:!0},{default:()=>[e(w,{value:n.value,onUpdateValue:h=>{n.value=h}},null)]}),e("div",{class:"flex justify-end"},[e(b,{disabled:n.value.length===0,type:"primary",onClick:p,round:!0,size:"small"},{default:()=>[d("创建")]})])]})}),{data:o,mutate:l}=W("current-disable-status",async()=>{const{data:a}=await m.api.options("authSecurity").get();return a}),i=a=>{m.api.options("authSecurity").patch({data:{disablePasswordLogin:a}}).then(()=>{l()})};return r.props=["dialog"],()=>e(pe,{embedded:!0,class:"!overflow-visible"},{default:()=>[e(oe,{class:"absolute right-0 top-[-3rem]"},{default:()=>[e(b,{type:"tertiary",onClick:()=>{G.validate(!0)},round:!0},{default:()=>[e(M,null,{default:()=>[e($e,null,null)]}),e("span",{class:"ml-2"},[d("验证")])]}),e(b,{round:!0,type:"primary",onClick:()=>{const a=dialog.create({title:"创建 Passkey",content:()=>e(r,{dialog:a},null)})}},{default:()=>[e(M,null,{default:()=>[e(ce,null,null)]}),e("span",{class:"ml-2"},[d("新增")])]})]}),e(C,{class:"mt-4",labelAlign:"left",labelPlacement:"left"},{default:()=>[e(f,{label:"禁止密码登入"},{default:()=>[e($,{value:o.value?.disablePasswordLogin,onUpdateValue:a=>{u.value?.length||message.error("至少需要一个 Passkey 才能开启这个功能"),i(a)}},null)]}),e("div",{class:"-mt-8 mb-4"},[e(E,{class:"mb-2 text-xs",depth:3},{default:()=>[e("span",null,[d("禁用密码登录需要至少开启 Clerk 或者 PassKey 登录的一项")])]})])]}),e(de,{scrollX:Math.max(800,t.contentWidth.value-t.contentInsetWidth.value),remote:!0,bordered:!1,data:u.value,columns:[{key:"name",title:"名称"},{title:"创建时间",key:"created",render({created:a}){return e(j,{time:a},null)}},{title:"操作",key:"id",render({id:a,name:n}){return e(N,null,{default:()=>[e(D,{positiveText:"取消",negativeText:"删除",onNegativeClick:()=>{c(a)}},{trigger:()=>e(b,{text:!0,type:"error"},{default:()=>[d("删除")]}),default:()=>e("span",{class:"max-w-48"},[d('确定要删除 Passkey "'),n,d('"?')])})]})}}]},null)]})}),te={GitHub:"github",Weibo:"weibo",网易云:"netease",哔哩哔哩:"bilibili"},bt="_avatar_1o1mi_3",ae={"tab-user":"_tab-user_1o1mi_1",avatar:bt},yt=y(()=>{const t=g({});let u;async function s(){const l=await m.api.master.get();t.value=l,u={...l}}R(async()=>{await s()});const c=_e(),r=B(()=>re(u,t.value)),o=async()=>{const l=ve(We(r));l.socialIds&&(l.socialIds=t.value.socialIds),await m.api.master.patch({data:l}),c.success("保存成功~"),await s()};return()=>e(x,null,[e(ze,{cols:"1 400:1 600:2",class:ae["tab-user"],xGap:20,yGap:20},{default:()=>[e(J,null,{default:()=>[e(C,{class:"flex flex-col items-center justify-center "},{default:()=>[e(f,null,{default:()=>[e("div",{class:ae.avatar},[e(et,{type:"avatar",onFinish:l=>{const{file:i,event:a}=l;try{const n=JSON.parse((a?.target).responseText);t.value.avatar=n.url}catch{}return i}},{default:()=>[e(tt,{class:"border-0 bg-transparent hover:border-0"},{default:()=>[e(He,{class:"flex",src:t.value.avatar,size:200},null)]})]})])]}),e(f,{label:"上次登录时间",class:"!mt-4"},{default:()=>[e("div",{class:"w-full text-center"},[e(E,null,{default:()=>[t.value.lastLoginTime?e(j,{time:t.value.lastLoginTime},null):"N/A"]})])]}),e(f,{label:"上次登录地址"},{default:()=>[e("div",{class:"w-full text-center"},[t.value.lastLoginIp?e(ie,{trigger:"hover",ip:t.value.lastLoginIp,triggerEl:e(E,{class:"cursor-pointer"},{default:()=>[t.value.lastLoginIp]})},null):"N/A"])]}),e(f,null,{default:()=>[e(b,{round:!0,class:"-mt-14",type:"primary",onClick:o,disabled:L(r.value)},{default:()=>[d("保存")]})]})]})]}),e(J,null,{default:()=>[e(C,null,{default:()=>[e(f,{label:"主人名 (username)"},{default:()=>[e(w,{value:t.value.username,onInput:l=>{t.value.username=l?.trim()||""}},null)]}),e(f,{label:"主人昵称 (name)"},{default:()=>[e(w,{value:t.value.name,onInput:l=>{t.value.name=l?.trim()||""}},null)]}),e(f,{label:"主人邮箱 (mail)"},{default:()=>[e(w,{value:t.value.mail,onInput:l=>{t.value.mail=l}},null)]}),e(f,{label:"个人首页"},{default:()=>[e(w,{value:t.value.url,onInput:l=>{t.value.url=l}},null)]}),e(f,{label:"头像"},{default:()=>[e(w,{value:t.value.avatar,onInput:l=>{t.value.avatar=l}},null)]}),e(f,{label:"个人介绍"},{default:()=>[e(w,{type:"textarea",resizable:!1,value:t.value.introduce,onInput:l=>{t.value.introduce=l}},null)]}),e(f,{label:"社交平台 ID 录入"},{default:()=>[e(Ze,{key:t.value.id,options:Object.keys(te).map(l=>({label:l,value:te[l]})),onChange:l=>{t.value.socialIds=l},value:t.value.socialIds||{}},null)]})]})]})]})])});var T=function(t){return t.User="user",t.System="system",t.Security="security",t}(T||{});const Ft=y({setup(){const t=Ge(),u=fe(),s=g(t.params.type);S(()=>t.params.type,r=>{r&&(s.value=r)});const c=g(null);return()=>e(Xe,{actionsElement:c.value},{default:()=>[e(Je,{value:s.value,onUpdateValue:r=>{u.replace({...t,params:{...t.params,type:r}})}},{default:()=>[e(q,{tab:"用户",name:T.User},{default:()=>[e(yt,null,null)]}),e(q,{tab:"系统",name:T.System},{default:()=>[e(ct,null,null)]}),e(q,{tab:"安全",name:T.Security},{default:()=>[e(pt,null,null)]})]})]})}});export{Ft as default};
